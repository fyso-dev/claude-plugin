# Fyso Platform — Consolidated Reference
<!-- AUTO-GENERATED by scripts/sync-reference.ts — DO NOT EDIT MANUALLY -->
<!-- Source: skills/*/reference/*.md — Last sync: 2026-02-25 -->

Quick-reference for all Fyso concepts. Read this ONE file instead of 8 individual reference files. For deep dives, read the source files in `skills/*/reference/`.

---

## 1. Field Types

| Type | Config | Use For |
|------|--------|---------|
| `text` | — | names, titles, codes, descriptions |
| `number` | `{ decimals: 0 }` | quantities, stock, counts |
| `number` | `{ decimals: 2 }` | prices, totals, money, percentages |
| `email` | — | email addresses (auto-validated) |
| `phone` | — | phone numbers |
| `date` | — | dates (no time) |
| `boolean` | — | flags (activo, disponible) |
| `select` | `{ options: ["a","b"] }` | status, type, category |
| `relation` | `{ entity: "x", displayField: "nombre" }` | foreign keys |

**Validations:** `required: true`, `unique: true`, `{ min, max }` (numbers), `{ minLength, maxLength }` (text), `{ pattern: "regex" }`.

**Conventions:** Entity names: lowercase plural Spanish. Field keys: snake_case. Money: always `number` with `decimals: 2`. Relations: always need `displayField`.

Source: `skills/fyso-entity/reference/field-types.md`

---

## 2. MCP Operations

### Tenant
```
select_tenant({ tenantSlug: "slug" })     # ALWAYS first
list_tenants()
```

### Entities
```
generate_entity({ definition: { entity: { name, displayName, description }, fields: [...] }, auto_publish: false })
list_entities({ include_drafts: true })
get_entity_schema({ entityName: "..." })
publish_entity({ entityName: "...", version_message: "..." })
```

### Business Rules
```
create_business_rule({ entityName, name, description, triggerType, triggerFields, ruleDsl: { compute, validate, transform }, auto_publish: false })
generate_business_rule({ entityName, prompt, auto_publish: false })
test_business_rule({ entityName, ruleId, testContext: { field: value } })
# success:true + computedValues     → compute rule OK ✅
# success:true + errors:[]          → validate OK, data is VALID ✅ (empty errors = working correctly)
# success:true + errors:[{message}] → validate OK, data failed as expected ✅
# success:false + error             → DSL bug ❌
publish_business_rule({ entityName, ruleId })
list_business_rules({ entityName })
delete_business_rule({ entityName, ruleId })
```

### Records
```
create_record({ entityName, data: { field: value } })
query_records({ entityName, limit, page, sort, order, filters: { field: value } })
update_record({ entityName, id, data: { field: newValue } })
delete_record({ entityName, id })
```

### Channels
```
publish_channel({ name, description, tags })
define_channel_tool({ channelId, toolName, description, parameters, entityMapping: { entity, operation } })
set_channel_permissions({ channelId, config: { public, allowedOperations } })
execute_channel_tool({ channelId, toolName, params })
```

### Metadata
```
export_metadata({ tenantId })     # JSON snapshot of all entities/rules
import_metadata({ metadata, tenantId })
```

Source: `skills/fyso-plan/reference/mcp-operations.md`

---

## 3. Business Rules DSL

### Structure
```json
{ "compute": { }, "validate": [ ], "transform": { } }
```

### Compute
```json
"field": { "type": "formula", "expression": "a * b" }
"field": { "type": "conditional", "conditions": [{ "when": "x > 10", "then": "x * 0.1" }], "default": "0" }
```
Fields execute in order — later fields can reference earlier ones.

### Validate
```json
{ "id": "unique_id", "condition": "price >= 0", "message": "Error msg", "severity": "error|warning|info" }
```

### Transform
```json
"field": { "type": "uppercase|lowercase|trim" }
"field": { "type": "round", "decimals": 2 }
"field": { "type": "default", "value": "pendiente" }
```

### Operators
- Arithmetic: `+ - * / % ^`
- Comparison: `> < >= <= == !=`
- Logical: `and or not`
- Inline conditional: `if(cond, true_val, false_val)`

### Functions
- Math: `floor(n) ceil(n) abs(n) min(a,b) max(a,b)`
- Text: `upper(s) lower(s) trim(s) len(s)`
- Utility: `coalesce(a, b, ...)`

### Trigger Types
- `field_change` — fires when specified fields change in UI (NOT from updateDataDirect)
- `before_save` — fires before record is saved (best for validations)
- `after_save` — fires after record is saved (for cross-entity updates)

Source: `skills/fyso-rules/reference/dsl-reference.md`

---

## 4. Limitations

| # | Limitation | Impact | Workaround |
|---|-----------|--------|------------|
| 1 | `field_change` triggers don't fire from `updateDataDirect` | High | Use `before_save` for critical validations |
| 2 | MCP session loses tenant context | Medium | Always `select_tenant` first in every task |
| 3 | Semantic search requires OPENAI_API_KEY + embedding worker | Medium | Use `query` with text filters instead |
| 4 | Channel slugs globally non-reusable once deleted | Medium | Choose names carefully, don't use temp names |
| 5 | Published entities with data resist schema changes | High | Design all fields before publishing |
| 6 | Compute chains must be in correct order | Medium | Order compute fields by dependency in DSL |
| 7 | `generate_entity` creates all fields at once (no individual create_field) | Low | Use full field list in generate_entity |
| 8 | DSL: no string interpolation, limited date math, no arrays, no API calls | Low | Keep expressions simple, use multiple rules |

| 9 | `deploy_static_site` response `url` field is wrong — returns `{slug}.fyso.dev` without `-sites` | High | Always use `{slug}-sites.fyso.dev` as the real URL, ignore the response `url` |
| 10 | Fyso static hosting ignores `_redirects` — BrowserRouter SPA routes 404 on direct access | High | Use Astro (generates per-route index.html) or HashRouter for SPAs |

**Things that work fine:** Multiple entity creation, rules after publish, relations, query_records, metadata import/export.

### Draft vs Published — Entity Lifecycle

**CRITICAL: Draft ≠ unusable.** Draft just means not yet exposed externally.

| State | Can add fields | Can create records | Can add rules | Accessible via channels/API |
|-------|---------------|-------------------|---------------|----------------------------|
| **Draft** | ✅ yes | ✅ yes | ✅ yes | ❌ no |
| **Published** | ⚠️ only if no data | ✅ yes | ✅ yes | ✅ yes |

**Never block work on a draft entity.** You can create records, test rules, and build relations on draft entities freely. Publishing only exposes the entity to external channels — it does not "activate" the entity for internal use.

Source: `skills/fyso-plan/reference/limitations.md`

---

## 5. Domain Patterns

### Healthcare / Clinic
- **Entities:** pacientes, profesionales, sesiones, facturas
- **Key relations:** sesiones→pacientes, sesiones→profesionales, facturas→pacientes, facturas→sesiones
- **Rules:** Compute: edad from fecha_nacimiento, Compute: total = subtotal + iva, iva = subtotal * 0.21, Validate: email format, Validate: fecha sesion not in past

### Retail / Store
- **Entities:** productos, clientes, ventas, detalle_venta
- **Key relations:** ventas→clientes, detalle_venta→ventas, detalle_venta→productos
- **Rules:** Compute: detalle subtotal = cantidad * precio_unitario, Compute: venta total = subtotal - descuento + iva, Compute: bajo_stock = stock < stock_minimo, Validate: cantidad > 0, Validate: stock >= 0

### Services / Consulting
- **Entities:** clientes, proyectos, tareas, facturas
- **Key relations:** proyectos→clientes, tareas→proyectos, facturas→clientes, facturas→proyectos
- **Rules:** Compute: factura total = subtotal + iva, Compute: proyecto horas_total = sum of tareas horas_reales (requires after_save action), Validate: fecha_fin >= fecha_inicio, Validate: horas_estimadas > 0

### Restaurant
- **Entities:** platos, mesas, pedidos, detalle_pedido
- **Key relations:** pedidos→mesas, detalle_pedido→pedidos, detalle_pedido→platos
- **Rules:** Compute: detalle subtotal = cantidad * precio_unitario, Validate: cantidad > 0, Validate: plato disponible == true

### Repair Shop / Workshop
- **Entities:** clientes, trabajos, repuestos, detalle_trabajo
- **Key relations:** trabajos→clientes, detalle_trabajo→trabajos, detalle_trabajo→repuestos
- **Rules:** Compute: detalle subtotal = cantidad * precio_unitario, Validate: stock >= 0, Transform: codigo → uppercase

### Inventory / Warehouse
- **Entities:** productos, proveedores, compras, movimientos
- **Key relations:** compras→proveedores, movimientos→productos
- **Rules:** Compute: margen = precio_venta - precio_costo, Compute: bajo_stock = stock < stock_minimo, Validate: cantidad > 0 (movimientos), Validate: stock >= 0

### Freelancer / Solo
- **Entities:** clientes, proyectos, facturas, pagos
- **Key relations:** proyectos→clientes, facturas→clientes, facturas→proyectos, pagos→facturas
- **Rules:** Compute: factura total = subtotal + iva, iva = subtotal * 0.21, Validate: monto pago > 0

Source: `skills/fyso-plan/reference/domain-patterns.md`

---

## 6. Auth & Roles

### Role Hierarchy
`owner > admin > member > viewer > public`

| Role | CRUD | Users | Config |
|------|------|-------|--------|
| owner | All entities, all ops | Create/manage all | Full |
| admin | All entities, all ops | Create/manage | Limited |
| member | Assigned entities, create/edit | Own profile only | None |
| viewer | Assigned entities, read-only | Own profile only | None |
| public | Public endpoints only | None | None |

### Auth Endpoints
```
POST /api/auth/tenant/login    → { token, user }
POST /api/auth/tenant/register → { token, user }  (if self-reg)
GET  /api/auth/tenant/me       → { user }
POST /api/auth/tenant/logout
```

### Headers
```
X-API-Key: {user-token}
X-Tenant-ID: {tenant-slug}
```

### Token Types
| Type | Scope | Storage |
|------|-------|---------|
| Admin API key | All ops, server only | `.env` (NEVER in browser) |
| User session token | Single tenant, role-based | Cookie or localStorage |
| OAuth access token | MCP operations | Memory |

Source: `skills/fyso-ui/reference/auth-patterns.md`

---

## 7. UI Components (@fyso/ui)

### Core Components
- **FysoProvider** — wraps app, provides API client + translations
- **DataGrid** — auto-columns from entity metadata, pagination, sort, mobile cards
- **DynamicForm** — auto-generated form from entity schema, validation, relation dropdowns
- **RecordDetail** — master-detail with child entity records
- **UI primitives** — Button, Input, Label, Table, Calendar (shadcn-based)

### Key Hooks
```tsx
useFysoEntity('entity')   → { entity, loading, error }
useFysoClient()           → client (records.list/get/create/update/delete)
useFyso()                 → { client, translations, entityCache }
```

### Record Data Shape
```
record.data.{fieldKey}    # NOT record.{fieldKey}
```

Source: `skills/fyso-ui/reference/fyso-ui-components.md`

---

## 8. UI Patterns

### Layouts
- **Sidebar** — admin panels (240px sidebar, collapsible on mobile)
- **TopNav** — simple apps, client portals
- **Landing + App** — public pages + authenticated area

### Page Types
- **Entity List** — DataGrid + search + filters + pagination + [+ New] button
- **Entity Detail** — RecordDetail + child entity tables
- **Entity Form** — DynamicForm (create/edit modes)
- **Dashboard** — KPI cards + recent activity + quick actions
- **Login/Register** — centered form
- **User Management** — admin: list + create/edit users

### Style Presets
| Preset | Primary | Background | Use For |
|--------|---------|------------|---------|
| Minimal | near-black | white | clean, simple apps |
| Professional | dark blue | white | admin panels, business |
| Modern | purple | white | client-facing, colorful |
| Dark | light text | near-black bg | dark mode default |

Source: `skills/fyso-ui/reference/ui-patterns.md`
